<% content_for :fullscreen, true %>

<div class="flex h-full" data-controller="sidebar">
  <%# Mobile overlay backdrop %>
  <div 
    class="fixed inset-0 bg-black/50 z-20 md:hidden hidden"
    data-sidebar-target="overlay"
    data-action="click->sidebar#close"
  ></div>

  <%# Sidebar %>
  <aside 
    class="fixed md:relative inset-y-0 left-0 z-30 w-64 bg-neutral-900 border-r-2 border-neutral-800 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-out"
    data-sidebar-target="panel"
  >
    <%# Logo/header %>
    <div class="p-4 border-b-2 border-neutral-800 flex items-center justify-between">
      <h1 class="text-lg text-[#00ff88] uppercase tracking-wider"><%= Current.user.account.name %></h1>
      <button 
        class="md:hidden text-neutral-400 hover:text-neutral-200 p-1"
        data-action="click->sidebar#close"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <%# Rooms list %>
    <nav class="flex-1 p-2 overflow-y-auto">
      <div class="text-xs uppercase tracking-wide text-neutral-500 px-3 py-2">Rooms</div>
      <% Current.user.rooms.each do |room| %>
        <%= link_to room_path(room), 
            class: "flex items-center gap-2 px-3 py-2 text-sm #{room == @room ? 'text-neutral-200 bg-neutral-800 border-l-2 border-[#00ff88]' : 'text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800 border-l-2 border-transparent'}",
            data: { action: "click->sidebar#close" } do %>
          <span class="text-neutral-500">#</span>
          <span><%= room.name.downcase %></span>
        <% end %>
      <% end %>
    </nav>

    <%# User section %>
    <div class="p-3 border-t-2 border-neutral-800">
      <%= link_to profile_path, class: "flex items-center gap-3 mb-3 p-2 -m-2 hover:bg-neutral-800 transition-colors" do %>
        <%= render "users/avatar", user: Current.user, size: "sm" %>
        <div class="flex-1 min-w-0">
          <div class="text-sm text-neutral-200 truncate"><%= Current.user.name %></div>
          <div class="text-xs text-neutral-500 truncate"><%= Current.user.email_address %></div>
        </div>
      <% end %>
      <div class="flex gap-2">
        <% if Current.user.admin? %>
          <%= link_to settings_path, class: "flex-1 px-3 py-1.5 text-xs text-center text-neutral-400 hover:text-neutral-200 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 uppercase tracking-wide transition-colors" do %>
            Settings
          <% end %>
        <% end %>
        <%= button_to session_path, method: :delete, class: "flex-1 px-3 py-1.5 text-xs text-center text-neutral-400 hover:text-neutral-200 bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 uppercase tracking-wide transition-colors cursor-pointer" do %>
          Sign Out
        <% end %>
      </div>
    </div>
  </aside>

  <%# Main content %>
  <main class="flex-1 flex flex-col min-w-0">
    <%# Mobile header %>
    <header class="md:hidden flex items-center gap-3 px-4 py-3 border-b-2 border-neutral-800 bg-neutral-900">
      <button 
        class="text-neutral-400 hover:text-neutral-200 p-1"
        data-action="click->sidebar#open"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
      <h2 class="text-neutral-200 flex items-center gap-1">
        <span class="text-neutral-500">#</span>
        <span><%= @room.name.downcase %></span>
      </h2>
    </header>

    <%# Desktop header %>
    <header class="hidden md:flex items-center px-4 py-3 border-b-2 border-neutral-800">
      <h2 class="text-neutral-200 flex items-center gap-1">
        <span class="text-neutral-500">#</span>
        <span><%= @room.name.downcase %></span>
      </h2>
    </header>

    <%# Messages %>
    <div 
      id="messages-container"
      class="flex-1 overflow-y-auto"
      data-controller="scroll"
      data-scroll-room-id-value="<%= @room.id %>"
    >
      <%= turbo_stream_from @room %>
      <div id="messages" class="py-4">
        <% @messages.each do |message| %>
          <%= render partial: "messages/message", locals: { message: message } %>
        <% end %>
      </div>
    </div>

    <%# Compose %>
    <div class="p-4 border-t-2 border-neutral-800">
      <%= render partial: "messages/form", locals: { room: @room, message: @message } %>
    </div>
  </main>
</div>
