<div 
  id="<%= dom_id(message) %>" 
  class="group flex items-start gap-3 px-4 py-2 hover:bg-neutral-900/50"
  data-controller="inline-edit<%= ' modal' if message.user == Current.user %>"
  data-inline-edit-url-value="<%= room_message_path(message.room, message) %>"
>
  <%= render "users/avatar", user: message.user, size: "sm" %>
  <div class="min-w-0 flex-1">
    <div class="flex items-baseline gap-2">
      <span class="text-sm font-medium text-neutral-200"><%= message.user.name %></span>
      <span class="text-xs text-neutral-600"><%= message.created_at.strftime("%l:%M %p").strip %></span>
      <% if message.user == Current.user %>
        <div data-controller="dropdown" class="relative ml-auto md:ml-0 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
          <button 
            type="button"
            data-action="click->dropdown#toggle"
            class="px-1 text-neutral-500 hover:text-neutral-300 active:text-neutral-300 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="6" r="1.5" fill="currentColor" />
              <circle cx="12" cy="12" r="1.5" fill="currentColor" />
              <circle cx="12" cy="18" r="1.5" fill="currentColor" />
            </svg>
          </button>
          <div 
            data-dropdown-target="menu"
            class="hidden absolute right-0 md:left-0 md:right-auto mt-1 z-50 min-w-28 bg-neutral-900 border-2 border-neutral-700 shadow-[4px_4px_0_0_#1a1a1a]"
          >
            <button 
              type="button"
              data-action="click->inline-edit#edit click->dropdown#close"
              class="w-full px-3 py-2 text-left text-sm text-neutral-300 hover:bg-neutral-800 hover:text-neutral-100 transition-colors"
            >
              Edit
            </button>
            <button 
              type="button"
              data-action="click->modal#open click->dropdown#close"
              class="w-full px-3 py-2 text-left text-sm text-red-400 hover:bg-neutral-800 hover:text-red-300 transition-colors"
            >
              Delete
            </button>
          </div>
        </div>
      <% end %>
    </div>
    <%# Display mode %>
    <div data-inline-edit-target="display" class="text-neutral-300 break-words whitespace-pre-wrap"><%= message.body %></div>
    
    <%# Edit mode %>
    <form 
      data-inline-edit-target="form" 
      data-action="submit->inline-edit#submit"
      class="hidden mt-1"
    >
      <textarea 
        data-inline-edit-target="input"
        data-action="keydown->inline-edit#cancelOnEscape"
        class="w-full px-3 py-2 bg-neutral-800 text-neutral-200 border-2 border-neutral-600 focus:border-[#00ff88] focus:outline-none focus:shadow-[0_0_10px_rgba(0,255,136,0.3)] resize-none"
        rows="2"
      ><%= message.body %></textarea>
      <div class="flex gap-2 mt-2">
        <button 
          type="submit"
          class="px-3 py-1.5 text-xs bg-[#00ff88] hover:bg-[#00cc6a] text-black font-medium border-2 border-black shadow-[2px_2px_0_0_#000] hover:shadow-[1px_1px_0_0_#000] hover:translate-x-[1px] hover:translate-y-[1px] transition-all uppercase tracking-wide"
        >
          Save
        </button>
        <button 
          type="button"
          data-action="click->inline-edit#cancel"
          class="px-3 py-1.5 text-xs bg-neutral-800 hover:bg-neutral-700 text-neutral-200 border-2 border-neutral-600 shadow-[2px_2px_0_0_#333] hover:shadow-[1px_1px_0_0_#333] hover:translate-x-[1px] hover:translate-y-[1px] transition-all uppercase tracking-wide"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
  
  <% if message.user == Current.user %>
    <%# Delete confirmation modal %>
    <dialog 
      data-modal-target="dialog"
      data-action="click->modal#closeOnBackdropClick"
      class="bg-transparent p-0 backdrop:bg-black/70 fixed inset-0 m-auto"
    >
      <div class="bg-neutral-900 border-2 border-neutral-700 shadow-[4px_4px_0_0_#1a1a1a] w-[calc(100vw-2rem)] sm:w-80 max-w-md mx-4 sm:mx-0">
        <div class="px-4 py-3 border-b-2 border-neutral-700 flex items-center justify-between">
          <h3 class="text-neutral-200 uppercase tracking-wide text-sm">Delete Message</h3>
          <button 
            type="button" 
            data-action="click->modal#close"
            class="text-neutral-500 hover:text-neutral-300 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-4">
          <p class="text-neutral-300 text-sm mb-4">Are you sure you want to delete this message? This action cannot be undone.</p>
          <div class="flex gap-2 justify-end">
            <button 
              type="button"
              data-action="click->modal#close"
              class="px-3 py-1.5 text-xs bg-neutral-800 hover:bg-neutral-700 text-neutral-200 border-2 border-neutral-600 shadow-[2px_2px_0_0_#333] hover:shadow-[1px_1px_0_0_#333] hover:translate-x-[1px] hover:translate-y-[1px] transition-all uppercase tracking-wide"
            >
              Cancel
            </button>
            <%= button_to room_message_path(message.room, message), 
                method: :delete, 
                class: "px-3 py-1.5 text-xs bg-red-600 hover:bg-red-500 text-white font-medium border-2 border-red-900 shadow-[2px_2px_0_0_#7f1d1d] hover:shadow-[1px_1px_0_0_#7f1d1d] hover:translate-x-[1px] hover:translate-y-[1px] transition-all uppercase tracking-wide" do %>
              Delete
            <% end %>
          </div>
        </div>
      </div>
    </dialog>
  <% end %>
</div>
