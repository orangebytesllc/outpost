#!/bin/bash
set -euo pipefail

# Deploy Outpost to production server
# Pulls the latest image and restarts the container using docker's --pull=always
#
# Required environment variables:
#   DEPLOY_HOST - Server hostname or IP address
#
# Optional environment variables:
#   DEPLOY_USER - SSH user (default: root)
#   CONTAINER_NAME - Docker container name (default: outpost)
#   IMAGE_TAG - Image tag to deploy (default: latest)

DEPLOY_USER="${DEPLOY_USER:-root}"
CONTAINER_NAME="${CONTAINER_NAME:-outpost}"
IMAGE_TAG="${IMAGE_TAG:-latest}"
IMAGE="ghcr.io/orangebytesllc/outpost:${IMAGE_TAG}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
  echo -e "${GREEN}==>${NC} $1"
}

warn() {
  echo -e "${YELLOW}Warning:${NC} $1"
}

error() {
  echo -e "${RED}Error:${NC} $1" >&2
  exit 1
}

# Validate required environment variables
if [[ -z "${DEPLOY_HOST:-}" ]]; then
  error "DEPLOY_HOST environment variable is required"
fi

log "Deploying ${IMAGE} to ${DEPLOY_HOST}"

# SSH connection string
SSH_TARGET="${DEPLOY_USER}@${DEPLOY_HOST}"

# Check that container exists
log "Checking current container status..."
if ! ssh "${SSH_TARGET}" "docker inspect ${CONTAINER_NAME}" &>/dev/null; then
  error "Container '${CONTAINER_NAME}' not found on server. Please start it manually first."
fi

CURRENT_IMAGE=$(ssh "${SSH_TARGET}" "docker inspect --format='{{.Config.Image}}' ${CONTAINER_NAME}")
echo "    Current image: ${CURRENT_IMAGE}"

# Pull the latest image
log "Pulling latest image..."
ssh "${SSH_TARGET}" "docker pull ${IMAGE}"

# Use docker update + restart approach to preserve all settings
# First, stop the container
log "Stopping container..."
ssh "${SSH_TARGET}" "docker stop ${CONTAINER_NAME}"

# Rename old container as backup
log "Backing up container config..."
ssh "${SSH_TARGET}" "docker rename ${CONTAINER_NAME} ${CONTAINER_NAME}_old"

# Get the run command from the old container and create new one
log "Creating new container with updated image..."
ssh "${SSH_TARGET}" "docker run -d \
  --name ${CONTAINER_NAME} \
  --restart unless-stopped \
  --publish \$(docker inspect --format='{{range \$p, \$conf := .HostConfig.PortBindings}}{{range \$conf}}{{.HostPort}}{{end}}{{end}}' ${CONTAINER_NAME}_old):80 \
  --volume outpost_storage:/rails/storage \
  \$(docker inspect --format='{{range .Config.Env}}-e {{.}} {{end}}' ${CONTAINER_NAME}_old) \
  ${IMAGE}"

# Verify the container is running
log "Verifying deployment..."
sleep 3
CONTAINER_STATUS=$(ssh "${SSH_TARGET}" "docker inspect --format='{{.State.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo 'unknown'")

if [[ "${CONTAINER_STATUS}" == "running" ]]; then
  NEW_IMAGE=$(ssh "${SSH_TARGET}" "docker inspect --format='{{.Config.Image}}' ${CONTAINER_NAME}")
  log "Deployment successful!"
  echo "    Container: ${CONTAINER_NAME}"
  echo "    Image: ${NEW_IMAGE}"
  echo "    Status: ${CONTAINER_STATUS}"
  
  # Remove the backup container
  log "Removing backup container..."
  ssh "${SSH_TARGET}" "docker rm ${CONTAINER_NAME}_old"
else
  # Rollback
  warn "Container failed to start, rolling back..."
  ssh "${SSH_TARGET}" "docker rm ${CONTAINER_NAME} 2>/dev/null || true"
  ssh "${SSH_TARGET}" "docker rename ${CONTAINER_NAME}_old ${CONTAINER_NAME}"
  ssh "${SSH_TARGET}" "docker start ${CONTAINER_NAME}"
  error "Deployment failed. Rolled back to previous version.\nCheck logs with: ssh ${SSH_TARGET} docker logs ${CONTAINER_NAME}"
fi

# Cleanup old images
log "Cleaning up old images..."
ssh "${SSH_TARGET}" "docker image prune -f --filter 'until=24h' || true"

log "Done!"
